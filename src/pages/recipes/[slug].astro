---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const recipes = await getCollection('recipes');
  return recipes.map((r) => ({ params: { slug: r.slug } }));
}

const { slug } = Astro.params;
const recipe = await getEntryBySlug('recipes', slug);
if (!recipe) throw new Error('Recipe not found');

const d = recipe.data;
const title = `${d.title} — Assorti.ai`;
const og = d.ogImage ?? "/img/og/default.png"; // fallback на общий OG

---
<Layout {title} description={d.summary} ogImage={d.preview ?? '/img/og.png'}>
  <a href="/recipes">← Все рецепты</a>
  <h1 style="margin-top:8px">{d.title}</h1>
  <p class="muted">{d.summary}</p>

  <div class="grid gap-6 md:grid-cols-[1.2fr,0.8fr] mt-4">
    <div>
      {d.preview && <img src={d.preview} alt={d.title} width="100%" style="border-radius:12px;border:1px solid #eee" />}
      <h2>Что получится</h2>
      <ul>
        {(d.outcome ?? []).map((o) => <li>{o}</li>)}
      </ul>

      <h2>Шаги (3–5)</h2>
      <ol>
        {(d.steps ?? []).map((s) => <li><b>{s.title}</b>: {s.description} {s.tip && <em class="muted">({s.tip})</em>}</li>)}
      </ol>

      {(d.prompts ?? []).length > 0 && <>
        <h2>Промпты</h2>
        {(d.prompts ?? []).map((p) => (
          <div class="copy" style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>{p.label}</strong>
              <button class="btn secondary" onclick={`navigator.clipboard.writeText(\`${p.content.replace('`','\`')}\`)`}>Copy</button>
            </div>
            <pre style="white-space:pre-wrap;">{p.content}</pre>
          </div>
        ))}
      </>}

      {d.youtube_id && <>
        <h2>Видео</h2>
        <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;border:1px solid #eee">
          <iframe src={`https://www.youtube.com/embed/${d.youtube_id}`} frameborder="0" allowfullscreen
            style="position:absolute;top:0;left:0;width:100%;height:100%"></iframe>
        </div>
      </>}
    </div>
    <aside class="space-y-3">
      <div class="card">
        <div class="p">
          <h3>Инструменты</h3>
          <ul>
            {(d.tools ?? []).map((t)=> <li><a href={(t.affiliate_url ?? t.url)} target="_blank" rel="noopener">{t.name}</a></li>)}
          </ul>
          <p class="muted">Стоимость: {d.cost_note ?? 'см. сайты инструментов'}</p>
          <p class="muted">ETA: {d.eta} минут</p>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="p">
          <h3>Disclosure</h3>
          <p class="muted">Некоторые ссылки партнёрские. Мы можем получать комиссию. Это не влияет на цену.</p>
        </div>
      </div>
    </aside>
  </div>
</Layout>
