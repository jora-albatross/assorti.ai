name: üß™ PR Preview to Cloudflare Pages

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build-and-preview:
    runs-on: ubuntu-latest

    # üëâ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞–¥–∞—ë–º —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤
    defaults:
      run:
        working-directory: ./

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm'  # –í–ê–ñ–ù–û: –∫–µ—à –≤—ã–∫–ª—é—á–µ–Ω, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª lock-—Ñ–∞–π–ª –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ
          # cache: 'npm'                <-- —É–¥–∞–ª–∏—Ç—å
          # cache-dependency-path: ...  <-- —É–¥–∞–ª–∏—Ç—å

      - name: üì¶ Install deps
        run: npm ci

      - name: üî® Build (Astro ‚Üí dist/)
        run: npm run build

      # –î–µ–ø–ª–æ–π –ø—Ä–µ–≤—å—é –Ω–∞ Cloudflare Pages
      - name: üöÄ Publish Preview to Cloudflare Pages
        id: pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PAGES_PROJECT }}
          directory: ./dist
          # –í–µ—Ç–∫–∞ –ø—Ä–µ–≤—å—é = –≤–µ—Ç–∫–∞ PR
          branch: ${{ github.head_ref }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å PR —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø—Ä–µ–≤—å—é
      - name: üí¨ Comment preview URL
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "‚úÖ **Preview deployed to Cloudflare Pages**",
              "",
              "- Branch: `" + context.payload.pull_request.head.ref + "`",
              "- Commit: `" + context.payload.pull_request.head.sha.substring(0,7) + "`",
              "",
              "üîó –û—Ç–∫—Ä–æ–π –ø—Ä–µ–≤—å—é –≤ —Ä–∞–∑–¥–µ–ª–µ **Deployments** Cloudflare Pages " +
              "(workflow –ø–∏—à–µ—Ç URL –≤ –ª–æ–≥–∏ —à–∞–≥–∞ `Publish Preview to Cloudflare Pages`)."
            ].join("\n");
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
