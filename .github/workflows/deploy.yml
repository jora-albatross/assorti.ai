name: üöÄ Deploy to Cloudflare Pages (by tag)

on:
  # –î–µ–ø–ª–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø—É—à–∏–º —Ç–µ–≥ –≤–∏–¥–∞ v1.2.3
  push:
    tags:
      - "v*.*.*"
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # üëâ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞–¥–∞—ë–º —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤
    defaults:
      run:
        working-directory: ./

    steps:
      # 1) –ß–µ–∫–∞—É—Ç–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      # 2) –°—Ç–∞–≤–∏–º Node.js (LTS) –∏ –≤–∫–ª—é—á–∞–µ–º npm cache
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm'  # –í–ê–ñ–ù–û: –∫–µ—à –≤—ã–∫–ª—é—á–µ–Ω, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª lock-—Ñ–∞–π–ª –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ
          # cache: 'npm'                <-- —É–¥–∞–ª–∏—Ç—å
          # cache-dependency-path: ...  <-- —É–¥–∞–ª–∏—Ç—å

      # 3) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: üì¶ Install dependencies
        run: npm install

      # 4) –°–±–æ—Ä–∫–∞ Astro ‚Üí dist/
      - name: üî® Build (Astro ‚Üí dist/)
        run: npm run build

      # 5) –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ Cloudflare Pages
      #    –ù—É–∂–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã:
      #    - CF_API_TOKEN     (Cloudflare API Token: Account->Cloudflare Pages->Edit + Account Settings Read)
      #    - CF_ACCOUNT_ID    (Account ID)
      #    - CF_PAGES_PROJECT (–∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ Pages, –Ω–∞–ø—Ä–∏–º–µ—Ä "assorti-ai")
      - name: üö¢ Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PAGES_PROJECT }}
          directory: ./dist
          # –¥–æ–±–∞–≤–∏–º GitHub —Ç–æ–∫–µ–Ω –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π/–ª–æ–≥–æ–≤ (–µ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–±–æ—Ä–∫—É –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: üì§ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: warn
